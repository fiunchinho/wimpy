---

wimpy_docker_compose_version: "1.11.1"
wimpy_docker_compose_file: "{{ lookup('env','PWD') }}/docker-compose-{{ wimpy_deployment_environment }}.yml"
wimpy_docker_compose_template: "templates/docker-compose.yml.j2"
wimpy_deploy_strategy: "rolling_asg"
wimpy_github_repository: ""
wimpy_service_start_timeout: 500s
wimpy_service_healthcheck_retries: 10

# Launch Configuration
wimpy_aws_region: "eu-west-1"
wimpy_aws_ami: "CoreOS-stable-*" # The latest version of this AMI name will be used
wimpy_aws_instance_type: "t2.small"
#wimpy_aws_instance_role: ~
wimpy_application_environment_vars: {}
wimpy_application_pre_commands: []
wimpy_application_post_commands: []
wimpy_application_additional_units: []

# CloudWatch logs
wimpy_aws_cloudwatch_enabled: True
wimpy_aws_logs_priority: 7

# Route53
wimpy_aws_dns_name: "{{ wimpy_project_name }}"
wimpy_aws_dns_ttl: "60"
wimpy_aws_dns_weight: "10"

# KMS
wimpy_aws_kms_key: ""

# S3
wimpy_aws_s3_application_bucket: ""
wimpy_aws_s3_bucket: ""

# Elastic Load Balancer
wimpy_aws_elb_enable: True # Whether or not to assign an ELB in front of the ASG instances
wimpy_aws_elb_scheme: "internal" # Private or public ip's for instances behind. Possible values: 'internal' or 'internet-facing'
wimpy_aws_elb_draining_timeout: "10" # Wait a specified timeout allowing connections to drain before terminating an instance
wimpy_aws_elb_enable_draining: "True"
wimpy_aws_elb_cross_az: "no" # Distribute load across all configured Availability Zones
wimpy_aws_elb_stickiness:
  enabled: no
  type: "loadbalancer"
wimpy_aws_elb_healthcheck_ping_protocol: "http"
wimpy_aws_elb_healthcheck_ping_path: "/health"
wimpy_aws_elb_healthcheck_response_timeout: 5
wimpy_aws_elb_healthcheck_interval: 10
wimpy_aws_elb_healthcheck_unhealthy_threshold: 2
wimpy_aws_elb_healthcheck_healthy_threshold: 3
wimpy_aws_elb_listeners:
  - protocol: "http"
    load_balancer_port: "80"
    instance_port: "{{ wimpy_app_port }}"

# Auto Scaling Group
wimpy_aws_autoscaling_keep_launch_configurations: "1"
wimpy_aws_autoscaling_min_size: "1"
wimpy_aws_autoscaling_max_size: "2"
wimpy_aws_autoscaling_desired_capacity: "1"
wimpy_aws_autoscaling_healthcheck_grace_period: "300"
wimpy_aws_autoscaling_signal_count: "1"
wimpy_aws_autoscaling_signal_timeout: "PT3M"
wimpy_aws_autoscaling_signal_min_successful: "100" # Percentage
wimpy_aws_autoscaling_destroy_previous: True
wimpy_aws_autoscaling_high_cpu_threshold: "85"
wimpy_aws_autoscaling_low_cpu_threshold: "20"
wimpy_aws_autoscaling_policies:
  - name: "{{ wimpy_project_name }}-cpu-high"
    scaling_adjustment: 1
    cooldown: 300
    adjustment_type: "ChangeInCapacity"

  - name: "{{ wimpy_project_name }}-cpu-low"
    scaling_adjustment: -1
    cooldown: 300
    adjustment_type: "ChangeInCapacity"
wimpy_aws_autoscaling_alarms:
  - name: "{{ wimpy_project_name }}-cpu-high"
    metric: "CPUUtilization"
    statistics: Average
    comparison: ">="
    threshold: "{{ wimpy_aws_autoscaling_high_cpu_threshold }}"
    period: 300
    evaluation_periods: 2
    unit: "Percent"
    description: "CPU utilization is >= {{ wimpy_aws_autoscaling_high_cpu_threshold }}% for two periods of 5 minutes."
    dimensions:
      AutoScalingGroupName: "{{ wimpy_project_name }}"
    scaling_policy_name: "{{ wimpy_project_name }}-cpu-high"

  - name: "{{ wimpy_project_name }}-cpu-low"
    metric: "CPUUtilization"
    statistics: Average
    comparison: "<"
    threshold: "{{ wimpy_aws_autoscaling_low_cpu_threshold }}"
    period: 300
    evaluation_periods: 2
    unit: "Percent"
    description: "CPU utilization is < {{ wimpy_aws_autoscaling_low_cpu_threshold }}% for two periods of 5 minutes"
    dimensions:
      AutoScalingGroupName: "{{ wimpy_project_name }}"
    scaling_policy_name: "{{ wimpy_project_name }}-cpu-low"

  - name: "{{ wimpy_project_name }}-healthy-nodes-low"
    metric: "HealthyHostCount"
    statistics: Average
    comparison: "<"
    threshold: "1"
    period: 300
    evaluation_periods: 1
    unit: "Count"
    description: "No healthy instances behind the ELB for 5 minutes"
    dimensions:
      ElasticLoadBalancerName: "GroupELB"
    scaling_policy_name: "{{ wimpy_project_name }}-healthy-nodes-low"
